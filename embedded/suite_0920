#include "green.h"

#define baudrate 115200
#define sumStep 3

const int ENA[sumStep] = {22, 32, 40};
const int DIR[sumStep] = {26, 36, 44};
const int STEP[sumStep] = {27, 37, 45};

const int digit[3] = {1000, 100, 10};

// if count value under 0 then stepping running, and initiate
int count = 4;
int pulse = 0;
char ch;

int preventdoubleENA = 0;

int pinno;
int setdir

int i;

green green(0);

void setup() {
  Serial.begin(baudrate);
  for (i= 0; i < sumStep; i++) {
    pinMode(ENA[i], OUTPUT);
    digitalWrite(ENA[i], HIGH);
    pinMode(DIR[i], OUTPUT);     
    pinMode(STEP[i], OUTPUT);
  }  
}

void loop() {
  if (Serial.available() > 0 ) { // # if
    ch = Serial.read();
    if (ch >= 48 && ch <= 57) { // ## if
      pulse += green.digitno(ch, count);
      count -= 1;
      if (count == 0) { // ### if_ stepping work phase
        Serial.print ("pulse : ");
        Serial.println (pulse);
        pulse = 0;
        count = 4;
        Serial.println ("stepping work");
      } else if (preventdoubleENA == 1) {
        if (65 <= ch && ch <=90) {
          setdir = 1;
          pinno = (ch - 65);
        } else if (97 <= ch && ch <= 122) {
          setdir = 2;
          pinno = (ch - 97);
        }
        green.idle(STEP[pinno], DIR[pinno], setdir);
      } else if (ch == 0) {
        for ( i = 0; i < sumStep; i++) { // ####for
          green.active(ENA[i], STEP[i]);
        } // #### for end
        preventdoubleENA = 1;
      } // ### if end
    } // ## if end
  } else {
    Serial.println ("stepping off");
    preventdoubleENA = 0;
    for ( i = 0; i < sumStep; i++) {
      green.Terminal(ENA[i], STEP[i]);
    }
  } // # serial end
}
